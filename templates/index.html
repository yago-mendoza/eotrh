<!DOCTYPE html>
<html lang="{{ config.DEFAULT_LOCALE }}"> <!-- Usa el locale de config -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Usa título desde i18n -->
    <title>{{ i18n.get("app_title", "EOTRH Watch") }}</title>
    
    <!-- Open Graph / Facebook Meta Tags -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://eotrh-software.onrender.com/">
    <meta property="og:title" content="{{ i18n.get('app_title', 'EOTRH Watch') }}">
    <meta property="og:description" content="{{ i18n.get('app_description', 'Assistent de Diagnòstic EOTRH per a professionals veterinaris') }}">
    <meta property="og:image" content="https://eotrh-software.onrender.com{{ url_for('static', path='assets/noulogo.png') }}">
    
    <!-- Twitter Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://eotrh-software.onrender.com/">
    <meta name="twitter:title" content="{{ i18n.get('app_title', 'EOTRH Watch') }}">
    <meta name="twitter:description" content="{{ i18n.get('app_description', 'Assistent de Diagnòstic EOTRH per a professionals veterinaris') }}">
    <meta name="twitter:image" content="https://eotrh-software.onrender.com{{ url_for('static', path='assets/noulogo.png') }}">
    
    <!-- Libraries JS (CDN) -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script> -->
    <!-- Gauge.js ya no se usa, usamos termómetro CSS -->
    <!-- CSS -->
    <link rel="stylesheet" href="{{ url_for('static', path='/css/style.css') }}">
    
    <!-- Inline styles for clinical findings section -->
    <style>
        .clinical-findings-section {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
        }
        
        /* Updated logo size */
        .app-logo {
            width: 250px; /* Reduced from 400px */
            height: auto;
            max-width: 100%;
            margin: 20px 0;
        }
        
        .clinical-stage {
            margin-bottom: 10px;
        }
        
        .stage-header {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .stage-label {
            font-size: 1.1em;
            margin: 0;
            font-weight: bold;
        }
        
        .findings-text {
            font-weight: bold;
            padding: 3px 10px;
            border-radius: 4px;
            color: white;
        }
        
        .comment-text {
            font-size: 0.95em;
            line-height: 1.4;
        }
        
        /* Stage-specific colors */
        .stage-0.findings-text {
            background-color: #28a745;
        }
        
        .stage-1.findings-text {
            background-color: #17a2b8;
        }
        
        .stage-2.findings-text {
            background-color: #fd7e14;
        }
        
        .stage-3.findings-text {
            background-color: #6f42c1;
        }
        
        .stage-4.findings-text {
            background-color: #dc3545;
        }
        
        .interpretive-comment {
            margin-top: 10px;
            padding: 10px;
            background-color: #fff;
            border-radius: 6px;
        }
        
        /* New border styles for specific sections */
        .score-item.digital-section {
            border: 2px solid #90caf9; /* Blue border for digital */
            border-radius: 8px;
            padding: 12px;
        }
        
        .score-item.radiographic-section { /* Green border for radiographic score */
            border: 2px solid #a5d6a7; /* Light green */
            border-radius: 8px;
            padding: 12px;
        }
        
        .entropy-analysis {
            border: 2px solid #90caf9; /* Blue border for entropy (linked to digital) */
            border-radius: 8px;
            padding: 15px;
        }
        
        .radiographic-interpretation-section { /* Green border for radiographic interpretation */
            border: 2px solid #a5d6a7; /* Light green */
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px; /* Add some space above */
            background-color: #f8f9fa; /* Match other sections */
        }
        
        /* Styling for the new radiograph warning */
        .warning-message {
            background-color: #fff9e6; /* Lighter yellow */
            border: 1px solid #ffeeba; /* Yellow border */
            color: #856404; /* Dark yellow text */
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px; /* Space below */
            font-size: 0.95em; /* Slightly smaller text */
        }

        .warning-message h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #856404; /* Match text color */
            font-size: 1.1em; /* Slightly larger heading */
        }

        .warning-message ol,
        .warning-message ul {
            margin-left: 25px; /* Indentation */
            padding-left: 0; /* Remove default padding if any */
            margin-top: 10px;
            margin-bottom: 10px;
        }
        
        .warning-message p {
            margin-bottom: 10px; /* Spacing between paragraphs */
        }
        .warning-message p:last-child {
            margin-bottom: 0; /* No extra space after the last paragraph */
        }

        .clinical-interpretation-section { /* Blue border for clinical interpretation */
            border: 1px solid #e9ecef; /* Changed to standard grey border like clinical-findings */
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px; /* Add some space above */
            background-color: #f8f9fa; /* Match other sections */
        }

        .title-container {
            text-align: center;
            margin: 10px 0;
        }
        .main-title {
            font-size: 140px;
            font-weight: 900;
            color: #0000FF;
            margin-bottom: 0;
            font-family: Arial, sans-serif;
            line-height: 1.2;
        }
        .subtitle {
            font-size: 20px;
            font-weight: bold;
            color: #0000FF;
            margin-top: 10px;
            font-family: Arial, sans-serif;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Logo y Título App -->
        <header class="app-header">
             <!-- Logo -->
             <img src="{{ url_for('static', path='assets/noulogo.png') }}"
                  alt="{{ i18n.get('logo_alt_text', 'App Logo') }}"
                  class="app-logo">
            <div class="title-container">
                <h1 class="main-title">{{ i18n.get("app_title", "EOTRH Watch") }}:</h1>
                <h2 class="subtitle">EOTRH Diagnosis Support Software</h2>
            </div>
        </header>

        <!-- Barra de Progrés (usa textos i18n) -->
        <nav class="progress-bar">
            <ul>
                <li id="progress-step-1" class="step active"><span>1</span> {{ i18n.get("progress_step1", "Upload") }}</li>
                <li id="progress-step-2" class="step"><span>2</span> {{ i18n.get("progress_step2", "ROI Edit") }}</li>
                <li id="progress-step-3" class="step"><span>3</span> {{ i18n.get("progress_step3", "Manual Data") }}</li>
                <li id="progress-step-4" class="step"><span>4</span> {{ i18n.get("progress_step4", "Results") }}</li>
            </ul>
        </nav>

        <main class="content-area">
            <!-- Mensaje de Error Global (opcional) -->
            <div id="global-error-message" class="error-message" style="display: none;"></div>

            <!-- Formulario principal -->
            <form id="diagnosis-form" action="{{ url_for('handle_calculation') }}" method="post" enctype="multipart/form-data">
                <!-- Campo oculto ROI -->
                <input type="hidden" id="roi_data" name="roi_data" value="[]">

                <!-- PAS 0: Upload -->
                <div id="step-upload" class="step-content {% if not results %}active{% endif %}">
                    <header class="step-header">
                        <h2>{{ i18n.get("welcome_title", "Welcome") }}</h2>
                        <p class="step-explanation">
                            {{ explanations.upload }} <!-- Texto viene del contexto -->
                        </p>
                    </header>
                    
                    <!-- START: Radiograph Recommendation Warning -->
                    <div class="warning-message">
                        <h4>{{ i18n.get("radiograph_warning_title", "Important recommendation for radiographs") }}</h4>
                        <p>{{ i18n.get("radiograph_warning_intro", "To ensure consistency and enhance diagnostic accuracy, it is strongly recommended that users acquire radiographs following a standardized methodology. The Hemisphere positioning model suggests obtaining three specific projections per patient:") }}</p>
                        <ol>
                            <li>{{ i18n.get("radiograph_warning_proj1", "Lateral view (90°/0°) – for general assessment of the oral structures.") }}</li>
                            <li>{{ i18n.get("radiograph_warning_proj2", "Dorsoventral intraoral oblique (0°/+45°) – for focused evaluation of the maxillary incisors.") }}</li>
                            <li>{{ i18n.get("radiograph_warning_proj3", "Ventrodorsal intraoral oblique (0°/−80°) – for detailed assessment of the mandibular incisors.") }}</li>
                        </ol>
                        <p>{{ i18n.get("radiograph_warning_conclusion", "Adhering to this protocol ensures optimal image quality and supports a more accurate diagnosis.") }}</p>
                    </div>
                    <!-- END: Radiograph Recommendation Warning -->
                    
                    <input type="file" id="image" name="image" accept="image/jpeg, image/png, image/bmp, image/tiff" required class="hidden-input">
                    <label for="image" class="upload-area" id="upload-zone">
                        <img src="{{ url_for('static', path='img/icon-upload.svg') }}" alt="Upload Icon" class="upload-icon">
                        <!-- Usa raw para permitir <strong> -->
                        <p>{{ i18n.get("upload_prompt", "Drag or click") | safe }}</p>
                        <div id="file-name-display"></div>
                        <div id="image-preview-container" style="display: none; margin-top: 15px; text-align: center;"></div>
                    </label>
                    <div class="navigation-buttons">
                        <button type="button" id="start-analysis-button" disabled>{{ i18n.get("start_analysis_button", "Start Analysis") }}</button>
                    </div>
                </div>

                <!-- PAS 0.5: Loading -->
                <div id="step-loading" class="step-content loading-screen">
                     <img src="{{ url_for('static', path='img/loading.gif') }}" alt="Loading..." class="loading-spinner">
                    <p>{{ i18n.get("loading_message", "Processing image...") }}</p>
                </div>

                <!-- PAS 1: Editor ROI -->
                <div id="step-roi-editor" class="step-content roi-editor-screen">
                     <header class="step-header">
                        <h2>{{ i18n.get("roi_editor_title", "ROI Editor") }}</h2>
                        <p class="step-explanation">
                            {{ explanations.roi }}
                        </p>
                    </header>
                    
                    <!-- START: ROI Selection Warning -->
                    <div class="warning-message">
                        <h4>{{ i18n.get("roi_warning_title", "How should the user select the ROIs?") }}</h4>
                        <p>{{ i18n.get("roi_warning_intro", "To ensure consistency and diagnostic validity in the automatic analysis, users must manually select two Regions of Interest (ROIs):") }}</p>
                        <ul>
                            <li>{{ i18n.get("roi_warning_tooth101", "The first upper right incisor (tooth 101)") }}</li>
                            <li>{{ i18n.get("roi_warning_tooth201", "The first upper left incisor (tooth 201)") }}</li>
                        </ul>
                        <p>{{ i18n.get("roi_warning_triadan", "These designations follow the modified Triadan system for equine dental nomenclature.") }}</p>
                        <p>{{ i18n.get("roi_warning_roi_intro", "Each ROI should:") }}</p>
                        <ul>
                            <li>{{ i18n.get("roi_warning_roi_char1", "Cover the largest possible area of both the tooth crown and the tooth root") }}</li>
                            <li>{{ i18n.get("roi_warning_roi_char2", "Be delimited by four high-radiodensity anatomical borders, ensuring precision and comparability in texture analysis") }}</li>
                        </ul>
                    </div>
                    <!-- END: ROI Selection Warning -->
                    
                    <div class="editor-layout">
                        <aside class="roi-toolbar">
                             <button type="button" id="tool-select" class="tool-button active" title="Select/Move (S)">
                                 <img src="{{ url_for('static', path='img/icon-select.svg') }}" alt="Select">
                             </button>
                            <button type="button" id="tool-polygon" class="tool-button" title="Draw Polygon (P)">
                                <img src="{{ url_for('static', path='img/icon-polygon.svg') }}" alt="Polygon">
                            </button>
                            <button type="button" id="tool-freehand" class="tool-button" title="Freehand Drawing (F)">
                                <img src="{{ url_for('static', path='img/icon-freehand.svg') }}" alt="Freehand">
                            </button>
                            <div class="tool-options" id="freehand-options" style="display:none;">
                                <label for="brush-size">Thickness:</label>
                                <input type="range" id="brush-size" min="1" max="20" value="3">
                                <span id="brush-size-value">3</span>px
                            </div>
                             <!-- Optional Grid Button -->
                            <hr>
                             <button type="button" id="tool-undo" class="tool-button" title="Undo (Ctrl+Z)">
                                 <img src="{{ url_for('static', path='img/icon-undo.svg') }}" alt="Undo">
                             </button>
                             <button type="button" id="tool-redo" class="tool-button" title="Redo (Ctrl+Y)">
                                 <img src="{{ url_for('static', path='img/icon-redo.svg') }}" alt="Redo">
                             </button>
                            <button type="button" id="tool-delete" class="tool-button" title="Delete Selected (Del)">
                                <img src="{{ url_for('static', path='img/icon-delete.svg') }}" alt="Delete">
                            </button>
                        </aside>
                        <section class="canvas-section">
                            <div id="canvas-wrapper">
                                <canvas id="roi-canvas"></canvas>
                            </div>
                             <div id="polygon-help-roi" class="tool-tip" style="display: none;">
                                 {{ i18n.get("polygon_tooltip", "Click to add points...") }}
                             </div>
                        </section>
                    </div>
                     <div class="navigation-buttons">
                         <button type="button" class="secondary" onclick="navigateStep('step-upload')">{{ i18n.get("back_to_upload_button", "Back to Upload") }}</button>
                        <button type="button" id="confirm-rois-button">{{ i18n.get("confirm_rois_button", "Confirm ROIs") }}</button>
                    </div>
                </div>

                <!-- PAS 2: Dades Manuals -->
                <div id="step-manual-data" class="step-content">
                    <header class="step-header">
                        <h2>{{ i18n.get("manual_data_title", "Manual Evaluation") }}</h2>
                         <p class="step-explanation">
                            {{ explanations.manual }}
                         </p>
                    </header>
                    <div class="tab-nav">
                        <button type="button" class="tab-link active" onclick="openTab(event, 'tab-clinical')">{{ i18n.get("tab_clinical", "Clinical Signs") }}</button>
                        <button type="button" class="tab-link" onclick="openTab(event, 'tab-radiographic')">{{ i18n.get("tab_radiographic", "Radiographic Signs") }}</button>
                    </div>

                     <div id="tab-clinical" class="tab-content active" style="display: block;"> <!-- Añadido active y display block inicial -->
                         <h3>{{ i18n.get("clinical_signs_subtitle", "Clinical Signs") }}</h3>
                          {% for key, options_list in clinical_options.items() %}
                         <div class="form-group">
                             <label for="{{ key }}">{{ key.replace('_', ' ').capitalize() }}:
                                {% if key == 'bite_angle_not_correlated_with_age' %}
                                    <img src="{{ url_for('static', path='img/icon-info.svg') }}"
                                         class="info-icon"
                                         alt="Info"
                                         title="*Pincer like: large angle between the maxillary and mandibular corner incisors">
                                {% endif %}
                             </label>
                             <select id="{{ key }}" name="{{ key }}" required class="score-select">
                                 {% for option_text, score in options_list %}
                                     <!-- **KEY CHANGE: value="{{ score }}"** -->
                                     <option value="{{ score }}" data-score="{{ score }}">{{ option_text }}</option>
                                 {% endfor %}
                             </select>
                         </div>
                         {% endfor %}
                     </div>
                     <div id="tab-radiographic" class="tab-content">
                          <h3>{{ i18n.get("radiographic_signs_subtitle", "Radiographic Signs") }}</h3>
                          {% for key, options_list in radiographic_options.items() %}
                          <div class="form-group">
                              <label for="{{ key }}">{{ key.replace('_', ' ').capitalize() }}:
                                 {# Remove the icon entirely for radiographic signs #}
                                 {# <img src="{{ url_for('static', path='img/icon-info.svg') }}"
                                      class="info-icon"
                                      alt="Info"
                                      title="{{ i18n.get('info_icon_tooltip', 'More information') }}">
                                 #}
                              </label>
                              <select id="{{ key }}" name="{{ key }}" required class="score-select">
                                  {% for option_text, score in options_list %}
                                     <!-- **KEY CHANGE: value="{{ score }}"** -->
                                      <option value="{{ score }}" data-score="{{ score }}">{{ option_text }}</option>
                                  {% endfor %}
                              </select>
                          </div>
                          {% endfor %}
                     </div>

                     <div class="navigation-buttons">
                         <button type="button" class="secondary" onclick="navigateStep('step-roi-editor')">{{ i18n.get("back_to_roi_button", "Back to ROI Edit") }}</button>
                        <!-- Cambiado a type="submit" -->
                        <button type="submit" id="calculate-button">{{ i18n.get("calculate_button", "Calculate Diagnosis") }}</button>
                    </div>
                </div>

            </form> <!-- Fin del formulario -->

            <!-- PAS 3: Resultats -->
             {% if results %}
            <div id="step-results" class="step-content results-screen active"> <!-- Añadido active si hay results -->
            {% else %}
            <div id="step-results" class="step-content results-screen"> <!-- Añadido para permitir resultados AJAX -->
            {% endif %}
                 <header class="step-header">
                     <h2>{{ i18n.get("results_title", "Results") }}</h2>
                     <p class="step-explanation">
                        {{ explanations.results }}
                     </p>
                 </header>

                 <div class="results-layout">
                     <section class="results-details">
                         <h3>{{ i18n.get("score_breakdown_title", "Score Breakdown") }}</h3>
                         <div class="score-breakdown">
                             <div class="score-item">
                                 <!-- Usa textos i18n -->
                                 <h4>{{ i18n.get("clinical_score_label", "Clinical") }} <img src="{{ url_for('static', path='img/icon-info.svg') }}" class="info-icon" alt="Info" title="{{ i18n.get('clinical_score_tooltip', 'Clinical score details') }}"></h4>
                                 <p>{{ results.puntuacio_clinica if results else "0" }} / {{ config.MAX_RAW_SCORES.clinical }}</p>
                                 <div class="score-bar-container"><div class="score-bar clinical" style="width: {{ (results.puntuacio_clinica / config.MAX_RAW_SCORES.clinical * 100)|int if results else 0 }}%;"></div></div>
                             </div>
                             <div class="score-item radiographic-section"> <!-- Added radiographic-section class -->
                                 <h4>{{ i18n.get("radiographic_score_label", "Radiographic") }} <img src="{{ url_for('static', path='img/icon-info.svg') }}" class="info-icon" alt="Info" title="{{ i18n.get('radiographic_score_tooltip', 'Radiographic score details') }}"></h4>
                                 <p>{{ results.puntuacio_radio if results else "0" }} / {{ config.MAX_RAW_SCORES.radio }}</p>
                                 <div class="score-bar-container"><div class="score-bar radiographic" style="width: {{ (results.puntuacio_radio / config.MAX_RAW_SCORES.radio * 100)|int if results else 0 }}%;"></div></div>
                             </div>
                             <div class="score-item digital-section">
                                 <!-- Tooltip dinámico con valor DistEn -->
                                 {% set digital_tooltip = i18n.get('digital_score_tooltip', '').format(max_dist_en_value=results.max_dist_en_value if results else 0) %}
                                 <h4>{{ i18n.get("digital_score_label", "Digital") }} <img src="{{ url_for('static', path='img/icon-info.svg') }}" class="info-icon" alt="Info" title="{{ digital_tooltip if digital_tooltip else i18n.get('digital_score_no_tooltip', 'Digital score details') }}"></h4>
                                 <p>{{ results.puntuacio_digital if results else "0" }} / 10</p>
                                 <div class="score-bar-container"><div class="score-bar digital" style="width: {{ (results.puntuacio_digital / 10 * 100)|int if results else 0 }}%;"></div></div>
                             </div>
                         </div>
                         
                         <!-- START: New Clinical Interpretation Section -->
                         <div class="clinical-interpretation-section"> <!-- Added new class for styling/JS -->
                             <h3>{{ i18n.get("clinical_interpretation_title", "Clinical interpretation") }}</h3>
                             <div class="clinical-stage">
                                 {% if results %}
                                     {% set clinical_score = results.puntuacio_clinica %}
                                     {% if clinical_score == 0 %}
                                         {% set stage_num = 0 %}
                                         {% set stage_name = i18n.get("clinical_stage_name_0", "0") %}
                                         {% set stage_name_text = i18n.get("clinical_stage_text_0", "Healthy") %} {# Textual Stage Name #}
                                         {% set findings = i18n.get("clinical_findings_text_0", "No findings, healthy") %}
                                         {% set stage_comment = i18n.get("clinical_comment_0", "Clinical normality. Subclinical disease cannot be ruled out. Radiographic assesment is recommended in older horses (>20 years)") %}
                                         {% set stage_class = "stage-0" %}
                                     {% elif clinical_score >= 1 and clinical_score <= 2 %}
                                         {% set stage_num = 1 %}
                                         {% set stage_name = i18n.get("clinical_stage_name_1", "1") %}
                                         {% set stage_name_text = i18n.get("clinical_stage_text_1", "Suspicious") %} {# Textual Stage Name #}
                                         {% set findings = i18n.get("clinical_findings_text_1", "Suspicious") %}
                                         {% set stage_comment = i18n.get("clinical_comment_1", "Minimal and non-specific signs. May be age-related. Clinical indicators such as gingival recession or gingivitis increase the risk of underlying disease and should prompt further monitoring. Radiographic assesment is advised.") %}
                                         {% set stage_class = "stage-1" %}
                                     {% elif clinical_score >= 3 and clinical_score <= 5 %}
                                         {% set stage_num = 2 %}
                                         {% set stage_name = i18n.get("clinical_stage_name_2", "2") %}
                                         {% set stage_name_text = i18n.get("clinical_stage_text_2", "Mild") %} {# Textual Stage Name #}
                                         {% set findings = i18n.get("clinical_findings_text_2", "Mild") %}
                                         {% set stage_comment = i18n.get("clinical_comment_2", "Presence of clear clinical signs but localized. Radiographic assesment is recommended to stage the lesions.") %}
                                         {% set stage_class = "stage-2" %}
                                     {% elif clinical_score >= 6 and clinical_score <= 9 %}
                                         {% set stage_num = 3 %}
                                         {% set stage_name = i18n.get("clinical_stage_name_3", "3") %}
                                         {% set stage_name_text = i18n.get("clinical_stage_text_3", "Moderate") %} {# Textual Stage Name #}
                                         {% set findings = i18n.get("clinical_findings_text_3", "Moderate") %}
                                         {% set stage_comment = i18n.get("clinical_comment_3", "Multiple clinical signs with moderate intensity. Suggestive of disease progression. Radiographic assesment is strongly recommended to evaluate lesion severity and progression") %}
                                         {% set stage_class = "stage-3" %}
                                     {% else %} {# score >= 10 #}
                                         {% set stage_num = 4 %}
                                         {% set stage_name = i18n.get("clinical_stage_name_4", "4") %}
                                         {% set stage_name_text = i18n.get("clinical_stage_text_4", "Severe") %} {# Textual Stage Name #}
                                         {% set findings = i18n.get("clinical_findings_text_4", "Severe") %}
                                         {% set stage_comment = i18n.get("clinical_comment_4", "Generalized and severe clinical involvement. Common findings include gingival swelling, fistulae, and bite angle not correlated with age. Radiological assessment is essential at this stage to accurately characterize lesion severity, as the extent of radiographic changes and associated pain may warrant extraction of the affected teeth.") %}
                                         {% set stage_class = "stage-4" %}
                                     {% endif %}
                                     <div class="stage-header">
                                         <span class="findings-text {{ stage_class }}">{{ findings }}</span>
                                     </div>
                                     <div class="interpretive-comment">
                                         <p class="comment-text {{ stage_class }}">{{ stage_comment }}</p>
                                     </div>
                                 {% else %}
                                     <div class="stage-header">
                                         <span class="findings-text">{{ i18n.get("clinical_findings_text_none", "Not available") }}</span>
                                     </div>
                                     <div class="interpretive-comment">
                                         <p class="comment-text">{{ i18n.get("clinical_comment_none", "Not available") }}</p>
                                     </div>
                                 {% endif %}
                             </div>
                         </div>
                         <!-- END: New Clinical Interpretation Section -->
                         
                         <!-- START: Updated Radiographic Interpretation Section -->
                         <div class="radiographic-interpretation-section"> <!-- Green border for radiographic interpretation -->
                             <h3>{{ i18n.get("radiographic_interpretation_title", "Radiographic interpretation") }}</h3>
                             <div class="clinical-stage"> <!-- Reusing class name, context is radiographic -->
                                 {% if results %}
                                     {% set radio_score = results.puntuacio_radio %}
                                     {# Use new texts based on score ranges #}
                                     {% if radio_score == 0 %}
                                         {% set stage_name = i18n.get("radiographic_stage_name_0", "Normal") %}
                                         {% set stage_comment = i18n.get("radiographic_desc_0", "No abnormal radiological findings. However, the first pathological changes may begin on the palatal/lingual side and may not yet be visible. In older horses or in the presence of clinical signs, periodic radiographic monitoring is advised.") %}
                                         {% set stage_class = "stage-0" %}
                                     {% elif radio_score >= 1 and radio_score <= 2 %}
                                         {% set stage_name = i18n.get("radiographic_stage_name_1", "Suspicious") %}
                                         {% set stage_comment = i18n.get("radiographic_desc_1", "Tooth shape preserved but sporadic deviations: slightly blunted root tip, surface irregular/rough, slightly altered tooth structure. Continued radiographic monitoring and clinical evaluations are recommended.") %}
                                         {% set stage_class = "stage-1" %}
                                     {% elif radio_score >= 3 and radio_score <= 5 %} {# ** SCORE RANGE UPDATED TO 3-5 FOR MILD ** #}
                                         {% set stage_name = i18n.get("radiographic_stage_name_2", "Mild") %}
                                         {% set stage_comment = i18n.get("radiographic_desc_2", "Tooth shape preserved, slightly blunted root tip, surface irregular/rough, slightly altered tooth structure. Extraction is not usually needed at this stage but regular monitoring is essential to assess structural changes or progression. Measuring gingival recession can help track disease progression.") %}
                                         {% set stage_class = "stage-2" %}
                                     {% elif radio_score >= 6 and radio_score <= 9 %}
                                         {% set stage_name = i18n.get("radiographic_stage_name_3", "Moderate") %}
                                         {% set stage_comment = i18n.get("radiographic_desc_3", "Tooth shape largely preserved, intra-alveolar tooth part is not wider than the clinical crown, obviously blunted root tip, surface irregular/rough, moderately altered tooth structure. Treatment planning should include follow-up radiographs and may require extraction of teeth that are painful, nonvital, or structurally compromised.") %}
                                         {% set stage_class = "stage-3" %}
                                     {% else %} {# score >= 10 #}
                                         {% set stage_name = i18n.get("radiographic_stage_name_4", "Severe") %}
                                         {% set stage_comment = i18n.get("radiographic_desc_4", "Loss of tooth shape, intra-alveolar tooth part is wider than the clinical crown, surface obviously irregular/rough, severely altered tooth structure. Extraction is often recommended, specially once supragingival lesions, alveolitis, osteomyelitis, tooth fractures, and extensive resorption of the reserve crown and root are detectable radiographically. The decision should be based on the veterinarian's clinical judgment, integrating both radiographic and clinical findings, with particular attention to a thorough dental pain assessment. Incisor extraction, when indicated, has a favorable prognosis and can significantly improve the horse's welfare.") %}
                                         {% set stage_class = "stage-4" %}
                                     {% endif %}
                                     <div class="stage-header">
                                         <span class="findings-text {{ stage_class }}">{{ stage_name }}</span> {# Show stage name as badge #}
                                     </div>
                                     <div class="interpretive-comment">
                                         {# Use Description label and the new comment text #}
                                         <p class="comment-text {{ stage_class }}">{{ stage_comment }}</p>
                                     </div>
                                 {% else %}
                                     <div class="stage-header">
                                         <span class="findings-text">{{ i18n.get("radiographic_stage_name_none", "N/A") }}</span>
                                     </div>
                                     <div class="interpretive-comment">
                                         <p class="comment-text">{{ i18n.get("radiographic_desc_none", "Not available") }}</p>
                                     </div>
                                 {% endif %}
                             </div>
                         </div>
                         <!-- END: Updated Radiographic Interpretation Section -->

                         <!-- Bloc d'Anàlisi Entropia del ROI (ARA DESPRÉS DE LES INTERPRETACIONS) -->
                         <div class="entropy-analysis">
                             <h3>{{ i18n.get("entropy_analysis_title", "Anàlisi Entropia del ROI") }}</h3>
                             <div class="entropy-metric">
                                 <label>{{ i18n.get("disten_label", "Distància Entropia 2D (DistEn2D)") }}</label>
                                 <div class="entropy-bar-container">
                                     <!-- Mostrar el valor postprocesado (DistEn2D/2) en la barra -->
                                     <div class="entropy-bar" style="width: {{ ((results.max_dist_en_value / 2) * 100)|round|int if results else 0 }}%;"></div>
                                     <div class="entropy-marker" style="left: {{ ((results.max_dist_en_value / 2) * 100)|round|int if results else 0 }}%;"></div>
                                 </div>
                                 <!-- Mostrar el valor postprocesado como porcentaje -->
                                 <div class="entropy-value">{{ ((results.max_dist_en_value / 2) * 100)|round|int if results else 0 }}%</div>
                             </div>
                             
                             <!-- REMOVED Clinical Findings section based on digital score (Verified Removal) -->
                             
                             <div class="entropy-interpretation">
                                 <p>
                                     {{ i18n.get("entropy_interpretation", "Aquest valor indica una alta irregularitat en la textura de la dent a la regió analitzada. Pot ser un indicador precoç de canvis morfològics associats a EOTRH, fins i tot amb signes clínics mínims.") }}
                                     <a href="#" class="info-link" onclick="showEntropyInfo(event)">{{ i18n.get("more_info_link", "ℹ️ Més informació") }}</a>
                                 </p>
                             </div>
                             <div class="entropy-technical-note">
                                 <p>{{ i18n.get("entropy_technical_note", "Mesurat segons Distribution Entropy 2D després de filtrat Normalize. Basat en Górski et al. (2022). Útil per detectar fases inicials i avançades d'EOTRH.") }}</p>
                             </div>
                         </div>
                        
                     </section>

                 </div>

                 <div class="navigation-buttons">
                    <!-- Botón para volver al inicio -->
                    <button type="button" onclick="window.location.href='{{ url_for('read_root') }}'">{{ i18n.get("new_evaluation_button", "New Evaluation") }}</button>
                 </div>
            </div>

        </main>

        <footer class="app-footer">
            <p>© {{ now().year }} – Developed by Martina Genova Blanch, with technical support from Yago Mendoza. Version 1.1</p>
        </footer>

    </div> <!-- /app-container -->

    <!-- Scripts JS (al final) -->
    <!-- Primero Fabric.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>

    <!-- Luego nuestra lógica principal y del editor (AHORA SOLO app.js) -->
    <script src="{{ url_for('static', path='/js/app.js') }}"></script>

    <!-- Modal for entropy information -->
    <div id="entropy-info-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h3>{{ i18n.get("entropy_modal_title", "Entropia de Distribució 2D (DistEn2D)") }}</h3>
            <div class="modal-body">
                <p>{{ i18n.get("entropy_modal_p1", "La Distància d'Entropia 2D (DistEn2D) és una mesura de la complexitat i irregularitat de la textura d'una imatge radiogràfica.") }}</p>
                <p>{{ i18n.get("entropy_modal_p2", "En el context de l'EOTRH (Reabsorció Dental Odontoclàstica Equina i Hipercementosi), aquest valor quantifica els canvis morfològics que poden indicar:") }}</p>
                <ul>
                    <li>{{ i18n.get("entropy_modal_li1", "Alteracions precoces en l'estructura dental") }}</li>
                    <li>{{ i18n.get("entropy_modal_li2", "Reabsorció òssia inicial") }}</li>
                    <li>{{ i18n.get("entropy_modal_li3", "Processos de hipercementosi") }}</li>
                </ul>
                <p>{{ i18n.get("entropy_modal_p3", "Un valor més alt (prop del 100%) indica major irregularitat i complexitat en la textura, sovint associat amb estadis més avançats de la malaltia.") }}</p>
                <p>{{ i18n.get("entropy_modal_p4", "Les investigacions de Górski et al. (2022) suggereixen que aquest biomarcador digital podria facilitar la detecció precoç de canvis patològics, fins i tot abans que siguin visibles en radiografies convencionals o es manifestin clínicament.") }}</p>
                <p>{{ i18n.get("entropy_modal_p5", "No obstant, en aquest projecte se n'ha fet una adaptació específica amb una finalitat principalment exploratòria, i els resultats s'han d'interpretar en aquest mateix context.") }}</p>
            </div>
        </div>
    </div>

    <script>
        // Function to show the entropy information modal
        function showEntropyInfo(event) {
            event.preventDefault();
            document.getElementById('entropy-info-modal').style.display = 'block';
        }

        // Close the modal when clicking on X
        document.querySelectorAll('.close-modal').forEach(function(element) {
            element.addEventListener('click', function() {
                this.closest('.modal').style.display = 'none';
            });
        });

        // Close the modal when clicking outside of it
        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        });
    </script>

    <!-- Code for AJAX form submission -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('diagnosis-form');
            
            // Define max scores
            const MAX_CLINICAL_SCORE = {{ config.MAX_RAW_SCORES.clinical }};
            const MAX_RADIO_SCORE = {{ config.MAX_RAW_SCORES.radio }};
            
            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    navigateStep('step-loading');
                    
                    const formData = new FormData(form);
                    
                    fetch('/api/calculate', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Server response error: ' + response.status);
                        }
                        return response.json();
                    })
                    .then(results => {
                        console.log('Results received:', results);
                        
                        // Update clinical score
                        const clinicalScore = document.querySelector('.score-item:nth-child(1) p');
                        const clinicalBar = document.querySelector('.score-item:nth-child(1) .score-bar');
                        if (clinicalScore && clinicalBar) {
                            clinicalScore.textContent = `${results.puntuacio_clinica} / ${MAX_CLINICAL_SCORE}`;
                            clinicalBar.style.width = `${(results.puntuacio_clinica / MAX_CLINICAL_SCORE * 100)}%`;
                        }
                        
                        // Update radiographic score
                        const radioScore = document.querySelector('.score-item:nth-child(2) p');
                        const radioBar = document.querySelector('.score-item:nth-child(2) .score-bar');
                        if (radioScore && radioBar) {
                            radioScore.textContent = `${results.puntuacio_radio} / ${MAX_RADIO_SCORE}`;
                            radioBar.style.width = `${(results.puntuacio_radio / MAX_RADIO_SCORE * 100)}%`;
                        }
                        
                        // Update digital score
                        const digitalScore = document.querySelector('.score-item:nth-child(3) p');
                        const digitalBar = document.querySelector('.score-item:nth-child(3) .score-bar');
                        if (digitalScore && digitalBar) {
                            digitalScore.textContent = `${results.puntuacio_digital} / 10`;
                            digitalBar.style.width = `${(results.puntuacio_digital / 10 * 100)}%`;
                        }
                        
                        // Update entropy
                        const entropyPercentage = Math.round((results.max_dist_en_value / 2) * 100);
                        const entropyBar = document.querySelector('.entropy-bar');
                        const entropyMarker = document.querySelector('.entropy-marker');
                        const entropyValue = document.querySelector('.entropy-value');
                        if (entropyBar) entropyBar.style.width = `${entropyPercentage}%`;
                        if (entropyMarker) entropyMarker.style.left = `${entropyPercentage}%`;
                        if (entropyValue) entropyValue.textContent = `${entropyPercentage}%`;
                        
                        // Update classification
                        const classificationText = document.getElementById('classification-text-id');
                        if (classificationText) {
                            classificationText.innerHTML = `<strong>{{ i18n.get("classification_label", "Risk:") }} ${results.classificacio}</strong>`;
                        }

                        // Update Clinical Interpretation
                        const clinicalScore = results.puntuacio_clinica;
                        const clinicalSection = document.querySelector('.clinical-interpretation-section');
                        if (clinicalSection) {
                            const clinicalFindingsText = clinicalSection.querySelector('.findings-text');
                            const clinicalCommentText = clinicalSection.querySelector('.comment-text');

                            if (clinicalFindingsText && clinicalCommentText) {
                                // Remove previous classes
                                clinicalFindingsText.className = 'findings-text';
                                clinicalCommentText.className = 'comment-text';

                                let clinicalFindings, clinicalComment, clinicalStageClass;

                                if (clinicalScore === 0) {
                                    clinicalFindings = {{ i18n.get("clinical_findings_text_0", "No findings, healthy") | tojson }};
                                    clinicalComment = {{ i18n.get("clinical_comment_0", "Clinical normality. Subclinical disease cannot be ruled out. Radiographic assesment is recommended in older horses (>20 years)") | tojson }};
                                    clinicalStageClass = 'stage-0';
                                } else if (clinicalScore >= 1 && clinicalScore <= 2) {
                                    clinicalFindings = {{ i18n.get("clinical_findings_text_1", "Suspicious") | tojson }};
                                    clinicalComment = {{ i18n.get("clinical_comment_1", "Minimal and non-specific signs. May be age-related. Clinical indicators such as gingival recession or gingivitis increase the risk of underlying disease and should prompt further monitoring. Radiographic assesment is advised.") | tojson }};
                                    clinicalStageClass = 'stage-1';
                                } else if (clinicalScore >= 3 && clinicalScore <= 5) {
                                    clinicalFindings = {{ i18n.get("clinical_findings_text_2", "Mild") | tojson }};
                                    clinicalComment = {{ i18n.get("clinical_comment_2", "Presence of clear clinical signs but localized. Radiographic assesment is recommended to stage the lesions.") | tojson }};
                                    clinicalStageClass = 'stage-2';
                                } else if (clinicalScore >= 6 && clinicalScore <= 9) {
                                    clinicalFindings = {{ i18n.get("clinical_findings_text_3", "Moderate") | tojson }};
                                    clinicalComment = {{ i18n.get("clinical_comment_3", "Multiple clinical signs with moderate intensity. Suggestive of disease progression. Radiographic assesment is strongly recommended to evaluate lesion severity and progression") | tojson }};
                                    clinicalStageClass = 'stage-3';
                                } else {
                                    clinicalFindings = {{ i18n.get("clinical_findings_text_4", "Severe") | tojson }};
                                    clinicalComment = {{ i18n.get("clinical_comment_4", "Generalized and severe clinical involvement. Common findings include gingival swelling, fistulae, and bite angle not correlated with age. Radiological assessment is essential at this stage to accurately characterize lesion severity, as the extent of radiographic changes and associated pain may warrant extraction of the affected teeth.") | tojson }};
                                    clinicalStageClass = 'stage-4';
                                }

                                clinicalFindingsText.textContent = clinicalFindings;
                                clinicalFindingsText.classList.add(clinicalStageClass);
                                clinicalCommentText.textContent = clinicalComment;
                                clinicalCommentText.classList.add(clinicalStageClass);
                            }
                        }

                        // Update Radiographic Interpretation
                        const radioScore = results.puntuacio_radio;
                        const radioSection = document.querySelector('.radiographic-interpretation-section');
                        if (radioSection) {
                            const radioFindingsText = radioSection.querySelector('.findings-text');
                            const radioCommentText = radioSection.querySelector('.comment-text');

                            if (radioFindingsText && radioCommentText) {
                                // Remove previous classes
                                radioFindingsText.className = 'findings-text';
                                radioCommentText.className = 'comment-text';

                                let radioStageName, radioStageComment, radioStageClass;

                                if (radioScore === 0) {
                                    radioStageName = {{ i18n.get('radiographic_stage_name_0', 'Normal') | tojson }};
                                    radioStageComment = {{ i18n.get('radiographic_desc_0', 'No abnormal radiological findings. However, the first pathological changes may begin on the palatal/lingual side and may not yet be visible. In older horses or in the presence of clinical signs, periodic radiographic monitoring is advised.') | tojson }};
                                    radioStageClass = 'stage-0';
                                } else if (radioScore >= 1 && radioScore <= 2) {
                                    radioStageName = {{ i18n.get('radiographic_stage_name_1', 'Suspicious') | tojson }};
                                    radioStageComment = {{ i18n.get('radiographic_desc_1', 'Tooth shape preserved but sporadic deviations: slightly blunted root tip, surface irregular/rough, slightly altered tooth structure. Continued radiographic monitoring and clinical evaluations are recommended.') | tojson }};
                                    radioStageClass = 'stage-1';
                                } else if (radioScore >= 3 && radioScore <= 5) {
                                    radioStageName = {{ i18n.get('radiographic_stage_name_2', 'Mild') | tojson }};
                                    radioStageComment = {{ i18n.get('radiographic_desc_2', 'Tooth shape preserved, slightly blunted root tip, surface irregular/rough, slightly altered tooth structure. Extraction is not usually needed at this stage but regular monitoring is essential to assess structural changes or progression. Measuring gingival recession can help track disease progression.') | tojson }};
                                    radioStageClass = 'stage-2';
                                } else if (radioScore >= 6 && radioScore <= 9) {
                                    radioStageName = {{ i18n.get('radiographic_stage_name_3', 'Moderate') | tojson }};
                                    radioStageComment = {{ i18n.get('radiographic_desc_3', 'Tooth shape largely preserved, intra-alveolar tooth part is not wider than the clinical crown, obviously blunted root tip, surface irregular/rough, moderately altered tooth structure. Treatment planning should include follow-up radiographs and may require extraction of teeth that are painful, nonvital, or structurally compromised.') | tojson }};
                                    radioStageClass = 'stage-3';
                                } else {
                                    radioStageName = {{ i18n.get('radiographic_stage_name_4', 'Severe') | tojson }};
                                    radioStageComment = {{ i18n.get('radiographic_desc_4', "Loss of tooth shape, intra-alveolar tooth part is wider than the clinical crown, surface obviously irregular/rough, severely altered tooth structure. Extraction is often recommended, specially once supragingival lesions, alveolitis, osteomyelitis, tooth fractures, and extensive resorption of the reserve crown and root are detectable radiographically. The decision should be based on the veterinarian's clinical judgment, integrating both radiographic and clinical findings, with particular attention to a thorough dental pain assessment. Incisor extraction, when indicated, has a favorable prognosis and can significantly improve the horse's welfare.") | tojson }};
                                    radioStageClass = 'stage-4';
                                }

                                radioFindingsText.textContent = radioStageName;
                                radioFindingsText.classList.add(radioStageClass);
                                radioCommentText.textContent = radioStageComment;
                                radioCommentText.classList.add(radioStageClass);
                            }
                        }
                        
                        // Navigate to results
                        navigateStep('step-results');
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showGlobalError('Error processing data: ' + error.message);
                        navigateStep('step-manual-data');
                    });
                });
            }
            
            // Handle new evaluation button
            const newEvalButtons = document.querySelectorAll('button[onclick*="window.location.href"]');
            newEvalButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    window.location.href = '/';
                });
            });
        });
    </script>

</body>
</html>